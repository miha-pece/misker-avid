# misker-avidThis is BASH wrapper for ffmpeg with primary function of muxing AVID media files (Avid Technology, Inc.). It works in batch mode, so it will analyse and then mux (or transcode) all files stored in defined folder.This code was influenced with our archival footage, captured with Avid Xpress Pro and Avid Media Composer, which are now surpassed by different tools in our studio. Instead of re-capturing 100+ tapes, we decided for reusing old captured material, so we first had to mux separated streams back in one file.  ###File naming structureAVID editing programs separate different streams when capturing or transcoding media – for every stream there is a separate file. Files in media folder in our case were named with this pattern:	NewTape5A01.4F69D396.04CB60.mxf	NewTape5A02.4F69D396.04CB50.mxf	NewTape5V01.4F69D396.04CB70.mxf	NewTape5A01.4F69C7AE.1C9F50.mxf	NewTape5A02.4F69C7AE.1C9F40.mxf	NewTape5V01.4F69C7AE.1C9F60.mxfExplanation of name segments:	NewTape5 :	This was probably part of the name of captured tape or better clip, which is also truncated.	A01 / A02 / V01 :	This is signifier for audio 1 /audio 2 /video 1 stream.	4F69D396 :	Identification code (medium segment of name) for classifying streams: all streams from particular media file share the same ID.	04CB60 :	Unique identifier for particular stream.Three separate streams are probably most common pattern, but there are also tapes (or flash memory based files) with more audio channels, which would result in more separate streams/files.  With variable `$NUM_STREAMS` it is possible to define relevant number of streams/files for particular use-case.Script will count files in folder with “mxf” extension and divide them with `$NUM_STREMS` to check if all files are present. If numbers will not match, program will exit. This is not a bulletproof verification, so it has to be manually supervised. Script will ignore folders or files with different endings. All other files with “mxf” extension, like imported pictures, animations or similar, must be removed from the folder. Name patterns and stream numbers vary, so be careful on this issue and adapt name handling routines according to needs.  ###Script argumentsThere are two modes of operation: testing and processing.Test mode – `$PROCESSING=false` – will just check files. It will sort them by stream ID, modify and print their names on screen. It will also extract some metadata from files, like “reel_name” and “modification_date” and put them in file name for better readability (and replacement for truncated tape/file name). It’s easy to modify behaviour for different needs.Transform mode – `$PROCESSING=true` – will repeat test mode and then start transforming. It will join files with the same stream identification code.When transforming files, program has two options: muxing or transcoding. With muxing, it will just join separated streams in mxf container, with transcoding it will covert them in different format (implemented basic h264). You define operation with `$MUXING` variable.Transforming video files could be long process. There is option to transform only short segment of file with setting `$SHORT_TRANSFORM=true`. In that case only 10s of video from 20th second mark will be transformed.###Additional parametersAdditional parameters that has to be defined in script:`$NUM_STREAMS=3`  Number of connected streams, most common value is 3 (1v,2A)`$IN_FOLDER="/Volumes/My Book/Avid MediaFiles LaCie 2/MXF/1/"`  Source-folder with original media files. Define according to your specific case.`$OUT_FOLDER="/Volumes/VIDEO_R0/TMP/"`  Folder for muxed/encoded files. If not existent, it will be created. Define according to your specific case.`$FFMPEG_LOG_FILE=true`  Option for separating ffmpeg stdout to log-file instead on screen.###MiscellaneaFfmpeg and many other programs have problems reading stream aspect flag from AVID mxf files. When transcoding you have to manually define aspect if it is different than combination of SAR and resolution. In script we defined widescreen aspect: 16/9.###Testing environmentOSX with Bash 3.2.53, sed, awk. Ffmpeg version N-75160-gfb13513-tessus.###UsageDownload script and make it executable (chmod +x misker-avid.sh). Then adjust variables in script and run it (./misker-avid.sh).